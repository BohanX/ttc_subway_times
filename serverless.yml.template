service: ttc-subway-times

provider:
  name: aws
  runtime: python3.6
  timeout: 300
  iamRoleStatements:
    - Effect: Allow
      Action:
        - s3:PutObject
        - s3:GetObject
        - s3:ListBucket
      Resource: "arn:aws:s3:::${self:custom.bucket}/*"

package:
  exclude:
    - "**"
  include: # Specify the directories and files which should be included in the deployment package
    - writers.py
    - ttc_api_scraper.py
    - consolidate.py
    - db.cfg

functions:
  ttc_api_scrape:
    handler: src/ttc_api_scraper/ttc_api_scraper.handler
    events:
      - schedule:
          rate: cron(* 0-2,5-23 * * ? *)
          timezone: America/Toronto
    environment:
      S3_BUCKET: ${self:custom.bucket}
      LOG_LEVEL: INFO
      PYTHONPATH: src/ttc_api_scraper/

  consolidate:
    handler: src/ttc_api_scraper/consolidate.handler
    events:
      - schedule:
          rate: cron(20 4 * * ? *)
          timezone: America/Toronto
    environment:
      S3_BUCKET: ${self:custom.bucket}
      LOG_LEVEL: INFO
      PYTHONPATH: src/ttc_api_scraper/

plugins:
  - serverless-python-requirements
  - serverless-local-schedule

custom:
  pythonRequirements:
    dockerizePip: true

  bucket: <AWS S3 BUCKET>
